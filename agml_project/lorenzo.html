<html>
    <head>
        <script src="library/d3.min.js" charset="utf-8"></script>
        <title>BMI D3.js</title>
        
        <style>
            p {
            font-family: verdana;
            font-size: 0.7em;
            }
        </style>
        
    </head>
    <body>
        <p>
            <svg width="1500px", height="1000"></svg>
        </p>
        
        <script>
            
            d3.csv('../data/olympics_2012.csv',loaded);
            
            function loaded (data){
                
                var _data = [];
                data.forEach(function(d){
                    if(d.weight_kg > 0 && d.height_cm > 0
//                      &&  typeof d.weight_kg == 'number' && typeof d.weight_kg == 'number'
                      ){
                        _data.push(d)
                    }
                })
                
                function calc_bmi(d, gender){
                    return d3.median(d, function(c){
                        if(c.gender == gender){
                            return (c.weight_kg/Math.pow(c.height_cm/100, 2))
                        }
                    })
                }
                
                var sp = d3.nest()         
                            .key(function(d){
                                return d.sport;
                            })
                            .rollup(function(d){
                                return {
                                    avr_male_bmi: calc_bmi(d, 'Male'),
                                    avr_female_bmi: calc_bmi(d, 'Female'),
                                    athletes: d
                                }
                            })
                            .sortKeys(d3.ascending)
                            .entries(_data);
                                
                var mapx = d3.scale.linear()
                            .domain([0, sp.length])
                            .range([0, 10*sp.length+10])
                
                var hieghtscale = d3.scale.linear()
                                .domain([0, sp.value])
                                .range([0, 10*sp.value+10])
                
                var midpt = 200
                
                
                var groups = d3.select('svg')
                    .selectAll('g')
                    .data(sp)
                    .enter()
                    .append('g')
                    .attr('x', function(d,i){
                        return i*d
                    })
                    .attr('transform', function(d, i){
                        return 'translate(' + mapx(i) + ',0)'  
                    })
                    
                
                groups.append('rect')
                    .attr('width', 10)
                    .attr('height', function(d, i){
                        return d.values.avr_male_bmi
                    })

                    .attr('y', function(d, i){
                        return midpt - d.values.avr_male_bmi
                    })
                
                groups.append('rect')
                    .attr('width', 10)
                    .attr('height', function(d, i){
                        return d.values.avr_female_bmi
                    })

                    .attr('y', midpt)
                    .style('fill', 'red')
                
                
                groups.append('text')
                    .text(function(d){
                        return d.key
                    })
                    .attr('transform', 'rotate(90)') 

//                    .attr('y', 100)
//                    .attr('rotate', 90)
//                    .attr('transform', function(d, i){
//                        return 'translate(' + (i)*100 + ',0)'
//                      return 'translate(' + mapx(i) + ',0)'
//                    }

                console.log(sp)                   
            }
        </script>
    </body>
</html>