<html>
    <head>
        <script src="library/d3.min.js" charset="utf-8"></script>
        <title>Test D3.js</title>
    </head>
    <body>
        <svg width="100%" height="900"></svg>
        <script>
            d3.csv('../data/olympics_2012.csv',loaded);
            
            function loaded (data){
                
                var _data = []
                data.forEach(function(d){
                    if(d.medal != ""){
                        _data.push(d);
                    }
                })
                
                var zod = d3.nest()
                                .key(function(d){
                                    return d.medal;
                                })
                                .key(function(d){
                                    var mydata = d.birth.split('-');
                                    mydata = mydata[1] + '' + mydata[2];
                                    if(mydata > '0120' && mydata < '0220'){
                                        return 'acquario'; //Acquario - segno di Leo   
                                    }
                                    if(mydata > '0219' && mydata < '0321'){
                                        return 'pesci';
                                    }
                                    if(mydata > '0320' && mydata < '0421'){
                                        return 'ariete'; 
                                    }
                                    if(mydata > '0420' && mydata < '0521'){
                                        return 'toro'; 
                                    }
                                    if(mydata > '0520' && mydata < '0622'){
                                        return 'gemelli'; 
                                    }
                                    if(mydata > '0621' && mydata < '0723'){
                                        return 'cancro'; //Cancro - segno di Lorenzo
                                    }
                                    if(mydata > '0722' && mydata < '0824'){
                                        return 'leone';
                                    }
                                    if(mydata > '0823' && mydata < '0923'){
                                        return 'vergine';
                                    }
                                    if(mydata > '0922' && mydata < '1023'){
                                        return 'bilancia';//Bilancia - segno di Marta
                                    }
                                    if(mydata > '1022' && mydata < '1123'){
                                        return 'scorpione';
                                    }
                                    if(mydata > '1122' && mydata < '1222'){
                                        return 'sagittario'; //Sagittario - segno di Giovanni 
                                    }
                                    //if(mydata > '1221' && mydata < '0119'){
                                    //    return 'capricorno';
                                    //}
                                    else {
                                        return 'capricorno';
                                    }
                                })
                
                .sortKeys(d3.ascending)
                                .entries(_data);
                
                zod.sort(function(a,b) {
                    return d3.ascending(b.values.length, a.values.length)
                })
                
                var element = d3.nest()
                                .key(function(d){
                                    return d.medal;
                                })
                                .key(function(d){
                                    var mysign = d.birth.split('-');
                                    mysign = mysign[1] + '' + mysign[2];
                                    if(mysign > '0420' && mysign < '0521' ||        //ariete
                                        mysign > '0722' && mysign < '0824'||        //leone
                                        mysign > '1122' && mysign < '1222')         //sagittario
                                       {       
                                        return 'fuoco';  
                                    }
                                    if(mysign > '0520' && mysign < '0622' ||        //gemelli
                                        mysign > '0922' && mysign < '1023'||        //bilancia
                                        mysign > '0120' && mysign < '0220')         //acquario
                                       {       
                                        return 'aria';  
                                    }
                                    if(mysign > '0621' && mysign < '0723' ||        //cancro
                                        mysign > '1022' && mysign < '1123'||        //scorpione
                                        mysign > '0219' && mysign < '0321')         //pesci
                                       {       
                                        return 'acqua';  
                                    }
                                    /*if(mysign > '0420' && mysign < '0521' ||        //toro
                                        mysign > '0823' && mysign < '0923'||        //vergine
                                        mysign > '1221' && mysign < '0119')         //capricorno
                                       {       
                                        return 'terra';  
                                    }*/
                                    else {
                                        return 'terra';
                                    }
                                })
                 
                .sortKeys(d3.ascending)
                                .entries(_data);
                
                element.sort(function(a,b) {
                    return d3.ascending(b.values.length, a.values.length)
                })
                
                console.log(zod);
                console.log(element);
                
                var ang = Math.PI*2 / 12;
                
                var ang_small = Math.PI*2 / 4;
                
                var pathMedal = d3.svg.line()
                    .x(function(d, i){
                        return (Math.cos(ang*i) * d.values.length) * 1.8;
                    })
                    .y(function(d, i){
                        return (Math.sin(ang*i) * d.values.length) * 1.8;
                    })
                    .interpolate('cardinal-closed')
                    
                var pathForElement = d3.svg.line()
                    .x(function(d, i){
                        return (Math.cos(ang_small*i) * d.values.length) / 1.8;
                    })
                    .y(function(d, i){
                        return (Math.sin(ang_small*i) * d.values.length) / 1.8;
                    })
                    .interpolate('cardinal-closed')
                
                //////////////////////////////////////////////////////////////////
                // Segni zodiacali
                //////////////////////////////////////////////////////////////////
                var groups = d3.select('svg')
                    .selectAll('g')
                    .data(zod)
                    .enter()
                    .append('g')
                    .attr('transform', function(d, i){
                        return 'translate(' + (i+0.8)*450 + ',230)' // (traslazione x) , (traslazione y) 
                    })
                
                groups.append('path')
                    .attr('d', function(d, i){
                        return pathMedal(d.values)   
                    })
                    //.style('fill', '')
                
                groups.selectAll('.gr_sign')
                    .data(function(d){
                        return d.values;   
                    })
                    .enter()
                    .append('g')
                    .attr('transform', function(d, i){
                        return 'rotate('+360/12*i+'),translate(150,0)'
                    })
                
                    //inserisco il nome del segno
                    .attr('class', 'gr_sign')
                    //.append('text')
                    //    .text(function (d,i){
                    //    return d.key
                    .append('svg:image')
                    //.attr('xlink:href', 'library/zodiac_signs.svg')
                    .attr('xlink:href', function(d){
                        return 'library/images/' + d.key + '.svg';
                    })
                    .attr('width', 30)
                    .attr('height', 30 )
                    .attr('x', 0)
                    .attr('y',0);
                
                //////////////////////////////////////////////////////////////////
                //elementi
                //////////////////////////////////////////////////////////////////
                var groups_b = d3.select('svg')
                    .selectAll('.elem')
                    .data(element)
                    .enter()
                    .append('g')
                    .attr('class', 'elem')   
                    .attr('transform', function(d, i){
                        return 'translate(' + (i+0.8)*450 + ',650)' // (traslazione x) , (traslazione y) 
                    })
                
                groups_b.append('path')
                    .attr('d', function(d, i){
                        return pathForElement(d.values)   
                    })
                    //.style('fill', '')
                
                groups_b.selectAll('.gr_sign_2')
                    .data(function(d){
                        return d.values;   
                    })
                    .enter()
                    .append('g')
                    .attr('transform', function(d, i){
                        return 'rotate('+360/4*i+'),translate(120,0)'
                    })
                    .attr('class', 'gr_sign_2')
                    .append('text')
                    .text(function (d,i){
                        return d.key
                    })
                
                var groups_b = d3.select('svg')
                    .selectAll('.elem')
                    .data(element)
                    .enter()
                    .append('g')
                    .attr('class', 'elem')   
                    .attr('transform', function(d, i){
                        return 'translate(' + (i+0.8)*450 + ',650)' // (traslazione x) , (traslazione y) 
                    })
                
                //////////////////////////////////////////////////////////////////
                //legenda
                //////////////////////////////////////////////////////////////////
                
                
                
                
            }
        </script>
    </body>
</html>